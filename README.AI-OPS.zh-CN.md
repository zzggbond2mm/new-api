# New-API AI 协作与发布底线（长期维护版）

## 目标
- 支持两套环境：`dev`（调试）与 `prod`（上线）。
- 长期同步上游 `QuantumNous/new-api`，并保留本地定制。
- 让后续 AI 在上下文不完整时，仍能遵守同一套流程。

## Git 小白必懂
- `origin`：你的仓库（你 push 的地方）。
- `upstream`：上游官方仓库（只拉更新，不直接改）。
- `main`：生产稳定分支。
- `develop`：开发与调试分支。
- `feature/*`：单需求开发分支。
- `sync/upstream-main`：上游同步缓冲分支。

## 绝对底线（任何 AI 不可突破）
- 禁止直接在 `main` 开发或直接提交大改动。
- 禁止跳过 `develop` 直接发布到生产。
- 禁止把密钥和环境差异写死在源码中。
- 禁止使用破坏性命令处理冲突（如 `git reset --hard`）。
- 禁止未备份数据库就做生产迁移。

## 阶段与修改边界

### 阶段 A：初始化（只做一次）
- 建立双远端：`origin` + `upstream`。
- 创建分支：`main`、`develop`、`sync/upstream-main`。
- 准备双环境配置：`.env.dev`、`.env.prod`。
- 准备双服务：`new-api-dev.service`、`new-api-prod.service`。

### 阶段 B：日常开发
- 从 `develop` 拉出 `feature/*` 开发需求。
- 合并回 `develop` 后，先部署 `dev` 验证。
- 验证通过后，再从 `develop` 合并到 `main`。

### 阶段 C：同步上游
- 上游更新先进入 `sync/upstream-main`。
- 冲突处理与测试在 `sync/upstream-main` 完成。
- 通过后合并到 `develop`，稳定后再进 `main`。

### 阶段 D：生产发布
- 生产只从 `main`（或 `release/*`）发布。
- 每次发布都打 Tag（如 `v1.4.2`）。
- 发布后做健康检查，失败可快速回滚。

### 阶段 E：故障回滚
- 回滚代码到上一个稳定 Tag。
- 服务切回上一版目录/二进制并重启。
- 数据库回滚仅在可逆迁移或备份存在时进行。

## 代码层面防冲突原则
- 本地业务定制优先放扩展层，少改上游核心文件。
- 必须改核心时，在 PR/提交说明中写清改动原因与影响范围。
- 环境差异只放 `.env*`，不放业务分支判断。

## AI 接手固定流程（强制）
1. 先读本文件，再读 `README.zh_CN.md` 与部署脚本。
2. 先汇报当前分支、目标分支和风险，再实施改动。
3. 默认在 `feature/*` 或 `develop` 执行修改。
4. 涉及上游更新，必须先走 `sync/upstream-main`。
5. 收尾必须输出：变更文件、影响范围、回滚方式。

## AI 禁止事项
- 未经明确授权，禁止重建分支模型。
- 未经明确授权，禁止删除既有 dev/prod 双环境流程。
- 禁止省略测试、健康检查、备份步骤。

## 一句话总策略
- 开发走 `develop`，上线走 `main`，上游更新先走 `sync`，始终可回滚。
